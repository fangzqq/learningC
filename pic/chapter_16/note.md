# 其他及高级特性

- 理解 goto 语句，以及为什么要避免使用它
- 用”联合体“最大化利用空间
- 向程序中增加空语句
- 实现包含逗号运算符的语句
- 为程序使用命令行参数
- 用 malloc() 和 calloc() 动态分配内存，并用 free() 清理

## 其他语言语句

### goto 语句

在执行 goto 语句时会立即无条件进行跳转到指定的标签（label）位置，然后继续执行。

标签直接放在要跳转到的语句之前，而且必须与 goto 在同一个函数之内。

### 空语句

空语句是指一个单独的分号，其效果就是什么也不做：

```c
while ( (*text++ = getchar()) != '\n)
    ;
```

## 使用联合体

结构体与联合体的区别与内存的分配方式有关。

```c
union mixed
{
    char c;
    float f;
    int i;
};

union mixed x;
```

将 x 定义为仅包含成员，它的名字或者为 c，或者为 f。或者为 i。

利用联合体，可以定义一个能够存储不同数据类型的数组。

## 逗号运算符

在任何可以使用有效 C 表达式的地方，都可以使用逗号运算符分隔多个表达式，这些表达式自左向优求值：

```c
while (i < 100)
    sum += data[i], ++i;
```

在 C 语言中所有的运算符都生成一个值，所以逗号运算符的值就是最右边表达式的值。

## 类型限定符

### register 限定符：

- 基本数据类型通常都可以分配到寄存器中
- 指向任意数据类型的指针也可以被分配到寄存器中
- 使用 register 限定符的效果，最终取决于编译器
- 不能向 register 变量应用地址运算符

### volatile 限定符：

明确告知编译器，所指变量的值是会改变的，防止编译器在进行优化时产生误判

```c
volatile char *outPort;

*outport = 'O';
*outport = 'N';
```

### restrict 限定符

在某个值的作用域内，只有一个特定指针引用它（或间接或直接）。

```c
int * restrict intPtrA;
int * restrict intPtrB;
```

在定义 intPtrA 和 intPtrB 的作用域内，它们重来不会访问同一个值。

## 命令行参数

函数 main() 是在开始执行程序时由运行时系统实际调用的。当 main() 执行完毕时，控制被返回给运行时系统。

在运行时系统调用 main() 时，实际上向这个函数传送了两个参数：

- argc (argument count), 参数个数，是一个整数值
- argv (argument vector)，参数向量，是一个字符指针数组，包含 argc + 1 个字符指针

argc 的最小值总是 0，argv 中的第一项指向正在执行的程序的名字，argv 数组中的最后一个指针 `argv[argc]` 被定义为空。

为访问命令行参数，必须恰当地将 `main()` 函数定义为接受两个参数：

```c
int main (int argc, char *argv[])
{
    ...
}
```

## 动态内存分配

要使用动态内存分配，必须首先学习三个函数和一个新的运算符：

- calloc()
- malloc()
- free()
- sizeof

calloc() 函数接受两个参数：指定要提供的元素个数和每个元素的大小（单位为字节），返回一个指向 void 的指针，指向内存中已分配区域的开头，存储区域也被自动设定为 0。

void 是一种通用指针类型，可以使用类型转换运算符，将它转换为适当类型的指针。

malloc() 函数的工作方式与此类似，但只接受一个参数：所分配存储空间的总字节数，它不会自动将存储区域设定为 0。

这两个函数在 `<stdlib.h>` 中声明。

sizeof 运算符以字节为单位返回指定项目的大小，其参数可以是变量，数组名，基本数据类型的名字，派生数据类型的名字，或是一个表达式。

```c
#include <stdlib.h>

int *intPtr;

intPtr = (int *) calloc(sizeof(int), 1000);
intPtr = (int *) malloc(1000 * sizeof(int));
```

如果要求的内存超出了系统的可用内存， calloc 和 malloc 会返回一个空指针。

free 函数只有一个参数，是指向所分配内存开头的一个指针，该指针由 calloc() 或 malloc() 调用返回。

free 函数没有返回值。